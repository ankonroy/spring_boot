package com.example.spring_tutorial.service;

import com.example.spring_tutorial.exception.ResourceNotFoundException;
import com.example.spring_tutorial.model.Department;
import com.example.spring_tutorial.repository.DepartmentRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * Unit tests for DepartmentService.
 * Tests department CRUD operations.
 */
@ExtendWith(MockitoExtension.class)
public class DepartmentServiceTest {

    @Mock
    private DepartmentRepository departmentRepository;

    @InjectMocks
    private DepartmentService departmentService;

    private Department testDepartment;

    @BeforeEach
    void setUp() {
        testDepartment = new Department();
        testDepartment.setId(1L);
        testDepartment.setName("Computer Science");
        testDepartment.setCode("CS");
        testDepartment.setDescription("CS Department");
        testDepartment.setEstablishedDate(LocalDate.of(2020, 1, 1));
    }

    /**
     * Test 1: Verify successful department creation.
     */
    @Test
    void testCreateDepartment() {
        Department newDepartment = new Department();
        newDepartment.setName("Mathematics");
        newDepartment.setCode("MATH");
        newDepartment.setDescription("Math Department");

        when(departmentRepository.existsByCode("MATH")).thenReturn(false);
        when(departmentRepository.existsByName("Mathematics")).thenReturn(false);
        when(departmentRepository.save(any(Department.class))).thenAnswer(invocation -> {
            Department d = invocation.getArgument(0);
            d.setId(1L);
            return d;
        });

        Department created = departmentService.createDepartment(newDepartment);

        assertNotNull(created);
        assertEquals("Mathematics", created.getName());
        assertEquals("MATH", created.getCode());
        verify(departmentRepository).save(any(Department.class));
    }

    /**
     * Test 2: Verify getting all departments returns list.
     */
    @Test
    void testGetAllDepartments() {
        when(departmentRepository.findAll()).thenReturn(List.of(testDepartment));

        List<Department> departments = departmentService.getAllDepartments();

        assertNotNull(departments);
        assertEquals(1, departments.size());
        assertEquals("Computer Science", departments.get(0).getName());
    }

    /**
     * Test 3: Verify getting department by ID returns department when exists.
     */
    @Test
    void testGetDepartmentById() {
        when(departmentRepository.findById(1L)).thenReturn(Optional.of(testDepartment));

        Department found = departmentService.getDepartmentById(1L);

        assertNotNull(found);
        assertEquals(1L, found.getId());
        assertEquals("Computer Science", found.getName());
    }

    /**
     * Test 4: Verify department update works correctly.
     */
    @Test
    void testUpdateDepartment() {
        Department updatedDepartment = new Department();
        updatedDepartment.setName("Computer Science Updated");
        updatedDepartment.setCode("CS");
        updatedDepartment.setDescription("Updated Description");

        when(departmentRepository.findById(1L)).thenReturn(Optional.of(testDepartment));
        when(departmentRepository.save(any(Department.class))).thenAnswer(invocation -> invocation.getArgument(0));

        Department result = departmentService.updateDepartment(1L, updatedDepartment);

        assertEquals("Computer Science Updated", result.getName());
        assertEquals("Updated Description", result.getDescription());
    }

    /**
     * Test 5: Verify department deletion works correctly.
     */
    @Test
    void testDeleteDepartment() {
        when(departmentRepository.findById(1L)).thenReturn(Optional.of(testDepartment));
        doNothing().when(departmentRepository).delete(testDepartment);

        departmentService.deleteDepartment(1L);

        verify(departmentRepository).delete(testDepartment);
    }
}

